

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.png">
  <link rel="icon" href="/img/favicon.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="">
  <meta name="author" content="John Doe">
  <meta name="keywords" content="">
  <meta name="description" content="1. 协程我们知道计算机提供了线程与进程，但是协程并不是计算机提供的，协程是由程序员根据逻辑编程实现的。 协程是单线程中的程序在用户态中完成上下文切换的方法。 协程是在单线程中实现函数之间的代码块相互切换执行的方法。 例如： 123456789101112131415161718192021def func1():  print(1)  ...  print(2)def func2():  pri">
<meta property="og:type" content="article">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://example.com/2021/09/26/%E5%8D%8F%E7%A8%8B%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="1. 协程我们知道计算机提供了线程与进程，但是协程并不是计算机提供的，协程是由程序员根据逻辑编程实现的。 协程是单线程中的程序在用户态中完成上下文切换的方法。 协程是在单线程中实现函数之间的代码块相互切换执行的方法。 例如： 123456789101112131415161718192021def func1():  print(1)  ...  print(2)def func2():  pri">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2021-09-26T14:52:24.942Z">
<meta property="article:modified_time" content="2021-09-29T03:32:32.909Z">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary_large_image">
  
  <title>Hexo</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4/github-markdown.min.css" />
  <link  rel="stylesheet" href="/lib/hint/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10/styles/github-gist.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.css" />
  


<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.8.12","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname"}},"search_path":"/local-search.xml"};
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.4.0"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Fluid</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('/img/default.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2021-09-26 22:52" pubdate>
        2021年9月26日 晚上
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      20k 字
    </span>
  

  
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      63 分钟
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none"></h1>
            
            <div class="markdown-body">
              <h2 id="1-协程"><a href="#1-协程" class="headerlink" title="1. 协程"></a>1. 协程</h2><p>我们知道计算机提供了线程与进程，但是协程并不是计算机提供的，协程是由程序员根据逻辑编程实现的。</p>
<p><strong>协程是单线程中的程序在用户态中完成上下文切换的方法。</strong></p>
<p><strong>协程是在单线程中实现函数之间的代码块相互切换执行的方法。</strong></p>
<p>例如：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">func1</span>():</span><br>  <span class="hljs-built_in">print</span>(<span class="hljs-number">1</span>)<br>  ...<br>  <span class="hljs-built_in">print</span>(<span class="hljs-number">2</span>)<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">func2</span>():</span><br>  <span class="hljs-built_in">print</span>(<span class="hljs-number">3</span>)<br>  ...<br>  <span class="hljs-built_in">print</span>(<span class="hljs-number">4</span>)<br>  <br>func1()<br>func2()<br><span class="hljs-comment">#正常执行的顺序是：1 2 3 4</span><br><br><span class="hljs-comment">#引入协程后</span><br><span class="hljs-keyword">import</span> <span class="hljs-string">&quot;协程&quot;</span><br><span class="hljs-string">&quot;协程&quot;</span>_func1()<br><span class="hljs-string">&quot;协程&quot;</span>_func2()<br><span class="hljs-comment">#执行引入协程后的上述函数的结果可能是：1 3 2 4</span><br><span class="hljs-comment">#即&quot;协程&quot;_func1()执行一部分后，跳转至&quot;协程&quot;_func2()</span><br><span class="hljs-comment">#然后再继续执行&quot;协程&quot;_func1()，再执行&quot;协程&quot;_func2()</span><br></code></pre></td></tr></table></figure>

<p>实现上述协程的方法主要有以下4种：</p>
<ul>
<li>greenlet属于早期的协程模块；</li>
<li>yield关键字，它是python的生成器，可以保存函数当前的执行状态切换到其他函数执行，执行完之后切换回当前状态继续执行。通过yield关键字可以伪装成协程的流程；</li>
<li>asyncio装饰器</li>
<li><strong>async、await关键字（在python3.5版本以后）当前最主流的实现协程的方式。</strong></li>
</ul>
<h3 id="1-1-geenlet实现协程"><a href="#1-1-geenlet实现协程" class="headerlink" title="1.1 geenlet实现协程"></a>1.1 geenlet实现协程</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">pip3 install greenlet<br></code></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> greenlet <span class="hljs-keyword">import</span> greenlet<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">func1</span>():</span><br>  <span class="hljs-built_in">print</span>(<span class="hljs-number">1</span>)					<span class="hljs-comment">#第2步：输出1</span><br>  gr2.switch()			<span class="hljs-comment">#第3步：切换到func2函数</span><br>  <span class="hljs-built_in">print</span>(<span class="hljs-number">2</span>)					<span class="hljs-comment">#第6步：输出2</span><br>  gr2.switch()			<span class="hljs-comment">#第7步：切换到func2函数，从上一次执行的位置继续向后执行</span><br>  <br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">func2</span>():</span><br>  <span class="hljs-built_in">print</span>(<span class="hljs-number">3</span>)					<span class="hljs-comment">#第4步：输出3</span><br>  gr1.switch()			<span class="hljs-comment">#第5步：切换到func1函数，从上一次执行的位置继续向后执行</span><br>  <span class="hljs-built_in">print</span>(<span class="hljs-number">4</span>)					<span class="hljs-comment">#第8步：输出4</span><br>  <br>gr1 = greenlet(func1)<br>gr2 = greenlet(func2)<br><br>gr1.switch()				<span class="hljs-comment">#第1步：执行func1函数</span><br><br><span class="hljs-comment">#结果：1 3 2 4</span><br></code></pre></td></tr></table></figure>

<h3 id="1-2-yield关键字"><a href="#1-2-yield关键字" class="headerlink" title="1.2 yield关键字"></a>1.2 yield关键字</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">func1</span>():</span><br>  <span class="hljs-keyword">yield</span> <span class="hljs-number">1</span><br>  <span class="hljs-keyword">yield</span> <span class="hljs-keyword">from</span> func2()<br>  <span class="hljs-keyword">yield</span> <span class="hljs-number">2</span><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">func2</span>():</span><br>  <span class="hljs-keyword">yield</span> <span class="hljs-number">3</span><br>  <span class="hljs-keyword">yield</span> <span class="hljs-number">4</span><br>  <br>f1 = func1()<br><span class="hljs-keyword">for</span> item <span class="hljs-keyword">in</span> f1:				<br>  <span class="hljs-built_in">print</span>(item)				<span class="hljs-comment">#依次打印：1 3 4 2</span><br>  <br><span class="hljs-comment">#yield是生成器，因此func1和func2是生成器函数</span><br><span class="hljs-comment">#利用yield伪装的协程比较勉强，使用的不多</span><br></code></pre></td></tr></table></figure>

<h3 id="1-3-asyncio"><a href="#1-3-asyncio" class="headerlink" title="1.3 asyncio"></a>1.3 asyncio</h3><p>在python3.4版本及以后的版本都支持asyncio。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> asyncio<br><br><span class="hljs-meta">@asyncio.coroutine			</span><span class="hljs-comment">#装饰器装饰函数，定义为协程函数</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">func1</span>():</span><br>  <span class="hljs-built_in">print</span>(<span class="hljs-number">1</span>)<br>  <span class="hljs-keyword">yield</span> <span class="hljs-keyword">from</span> asyncio.sleep(<span class="hljs-number">2</span>)	<span class="hljs-comment">#遇到IO耗时操作时，自动切换到tasks中的其他任务</span><br>  <span class="hljs-built_in">print</span>(<span class="hljs-number">2</span>)<br>  <br><span class="hljs-meta">@asyncio.coroutine</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">func2</span>():</span><br>  <span class="hljs-built_in">print</span>(<span class="hljs-number">3</span>)<br>  <span class="hljs-keyword">yield</span> <span class="hljs-keyword">from</span> asyncio.sleep(<span class="hljs-number">2</span>)	<span class="hljs-comment">#遇到IO耗时操作时，自动切换到tasks中的其他任务</span><br>  <span class="hljs-built_in">print</span>(<span class="hljs-number">4</span>)<br>  <br><span class="hljs-comment">#将函数func1和func2封装到任务列表中</span><br>tasks = [<br>  asyncio.ensure_future( func1() ),<br>  asyncio.ensure_future( func2() )<br>]<br><br><span class="hljs-comment">#定义超级循环</span><br>loop = asyncio.get_event_loop()<br><span class="hljs-comment">#定义完成函数</span><br>loop.run_until_complete(asyncio.wait(tasks))<br></code></pre></td></tr></table></figure>

<p>注：<code>yield from asyncio.sleep()</code>等同于IO请求等耗时操作。<strong>asyncio的强大之处在于遇到IO阻塞时，会自动切换。greenlet模块和yield关键字需要人工手动添加切换位置。</strong></p>
<h3 id="1-4-关键字async、await"><a href="#1-4-关键字async、await" class="headerlink" title="1.4 关键字async、await"></a>1.4 关键字async、await</h3><p>在python3.5及以后的版本为了简化asyncio定义协程的方法，引入关键字<code>async</code>和<code>await</code>来简化asyncio定义协程的过程。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> asyncio<br><br><span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">func1</span>():</span><br>  <span class="hljs-built_in">print</span>(<span class="hljs-number">1</span>)<br>  <span class="hljs-keyword">await</span> asyncio.sleep(<span class="hljs-number">2</span>)	<span class="hljs-comment">#遇到IO耗时操作时，自动切换到tasks中的其他任务</span><br>  <span class="hljs-built_in">print</span>(<span class="hljs-number">2</span>)<br>  <br><span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">func2</span>():</span><br>  <span class="hljs-built_in">print</span>(<span class="hljs-number">3</span>)<br>  <span class="hljs-keyword">await</span> asyncio.sleep(<span class="hljs-number">2</span>)	<span class="hljs-comment">#遇到IO耗时操作时，自动切换到tasks中的其他任务</span><br>  <span class="hljs-built_in">print</span>(<span class="hljs-number">4</span>)<br>  <br><span class="hljs-comment">#将函数func1和func2封装到任务列表中</span><br>tasks = [<br>  asyncio.ensure_future( func1() ),<br>  asyncio.ensure_future( func2() )<br>]<br><br><span class="hljs-comment">#定义超级循环</span><br>loop = asyncio.get_event_loop()<br><span class="hljs-comment">#定义完成函数</span><br>loop.run_until_complete(asyncio.wait(tasks))<br></code></pre></td></tr></table></figure>

<p>即：用**<code>async</code>关键字<strong>修饰函数代替</strong><code>@asyncio.coroutine</code>修饰器<strong>修饰函数，用</strong><code>await</code>关键字<strong>定义IO阻塞位置代替</strong><code>yield from</code>关键字**定义IO阻塞位置。</p>
<p>综上所述，常用的方式<code>greenlet</code>和关键字<code>async</code>、<code>await</code>两种方式，更加推荐后者关键字<code>async</code>、<code>await</code>方式。</p>
<h3 id="1-5-协程的意义及实战案例"><a href="#1-5-协程的意义及实战案例" class="headerlink" title="1.5 协程的意义及实战案例"></a>1.5 协程的意义及实战案例</h3><p>协程的重要意义是，在单线程中，充分利用线程的IO等待时间，让线程去执行其他事情，而非干巴巴的等待IO事件。</p>
<p>下面用下载三张图片的时间对比<strong>串行方式和协程方法</strong>的速度。</p>
<h4 id="1-5-1-串行爬取"><a href="#1-5-1-串行爬取" class="headerlink" title="1.5.1 串行爬取"></a>1.5.1 串行爬取</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> requests<br><span class="hljs-keyword">import</span> time<br><br>headers = &#123;<br>    <span class="hljs-string">&quot;User-Agent&quot;</span>: <span class="hljs-string">&quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/14.1.2 Safari/605.1.15&quot;</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_images</span>(<span class="hljs-params">url</span>):</span><br>    filename = url.split(<span class="hljs-string">&quot;/&quot;</span>)[-<span class="hljs-number">2</span>] + <span class="hljs-string">&quot;.jpg&quot;</span><br>    data = requests.get(url,headers=headers).content<br>    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(filename,<span class="hljs-string">&#x27;wb&#x27;</span>) <span class="hljs-keyword">as</span> fp:<br>        fp.write(data)<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br><br>    strat = time.time()<br>    url_list = [<br>        <span class="hljs-string">&quot;https://uploadfile.bizhizu.cn/up/80/47/dd/8047dd9023aebb82a50a42dd11cf2897.png.230.350.jpg&quot;</span>,<br>        <span class="hljs-string">&quot;https://uploadfile.bizhizu.cn/up/e7/fd/05/e7fd0597635c1767431ddfd1d6d645e6.jpg.230.350.jpg&quot;</span>,<br>        <span class="hljs-string">&quot;https://uploadfile.bizhizu.cn/up/06/77/3f/06773fbb963b0ba66206ac82eb302d28.jpg.230.350.jpg&quot;</span><br>    ]<br><br>    <span class="hljs-keyword">for</span> url <span class="hljs-keyword">in</span> url_list:<br>        get_images(url)<br>    end = time.time()<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;use time seconds:&quot;</span>,end-strat)<br></code></pre></td></tr></table></figure>

<p>​        <strong>use time seconds: 8.751506090164185</strong></p>
<p>补：Python字符串split及rsplit方法原理详解：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs python">str1 = <span class="hljs-string">&quot;Hao123 hao456 hAo789&quot;</span><br>new_str = str1.split()<br>new_str2 = str1.split(<span class="hljs-string">&#x27; &#x27;</span>, <span class="hljs-number">1</span>)			<span class="hljs-comment">#从头部开始计数</span><br>new_str3 = str1.rsplit(<span class="hljs-string">&#x27; &#x27;</span>, <span class="hljs-number">1</span>)		<span class="hljs-comment">#从尾部开始计数</span><br> <br><span class="hljs-built_in">print</span>(new_str)<br><span class="hljs-built_in">print</span>(new_str2)<br><span class="hljs-built_in">print</span>(new_str3)<br> <br><span class="hljs-comment">#输出结果如下：</span><br>[<span class="hljs-string">&#x27;Hao123&#x27;</span>, <span class="hljs-string">&#x27;hao456&#x27;</span>, <span class="hljs-string">&#x27;hAo789&#x27;</span>]<br>[<span class="hljs-string">&#x27;Hao123&#x27;</span>, <span class="hljs-string">&#x27;hao456 hAo789&#x27;</span>]<br>[<span class="hljs-string">&#x27;Hao123 hao456&#x27;</span>, <span class="hljs-string">&#x27;hAo789&#x27;</span>]<br></code></pre></td></tr></table></figure>

<h4 id="1-5-2-协程爬取"><a href="#1-5-2-协程爬取" class="headerlink" title="1.5.2 协程爬取"></a>1.5.2 协程爬取</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> time<br><br><span class="hljs-keyword">import</span> aiohttp<br><span class="hljs-keyword">import</span> asyncio<br><br><span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">fetch</span>(<span class="hljs-params">session,url</span>):</span><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;发送请求：&quot;</span>,url)<br>    <span class="hljs-comment">#异步发送请求</span><br>    <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> session.get(url,verify_ssl=<span class="hljs-literal">False</span>) <span class="hljs-keyword">as</span> response:<br>        <span class="hljs-comment">#IO操作：等待网页读取数据库数据响应</span><br>        content = <span class="hljs-keyword">await</span> response.content.read()<br><br>        filename = url.split(<span class="hljs-string">&quot;/&quot;</span>)[-<span class="hljs-number">2</span>] + <span class="hljs-string">&quot;.jpg&quot;</span><br>        <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(filename,<span class="hljs-string">&#x27;wb&#x27;</span>) <span class="hljs-keyword">as</span> fp:<br>            fp.write(content)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;下载完成：&quot;</span>,url)<br><br><span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span>():</span><br>    <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> aiohttp.ClientSession() <span class="hljs-keyword">as</span> session:<br>        url_list = [<br>            <span class="hljs-string">&quot;https://uploadfile.bizhizu.cn/up/80/47/dd/8047dd9023aebb82a50a42dd11cf2897.png.230.350.jpg&quot;</span>,<br>            <span class="hljs-string">&quot;https://uploadfile.bizhizu.cn/up/e7/fd/05/e7fd0597635c1767431ddfd1d6d645e6.jpg.230.350.jpg&quot;</span>,<br>            <span class="hljs-string">&quot;https://uploadfile.bizhizu.cn/up/06/77/3f/06773fbb963b0ba66206ac82eb302d28.jpg.230.350.jpg&quot;</span><br>        ]<br>        tasks = [ asyncio.create_task(fetch(session,url)) <span class="hljs-keyword">for</span> url <span class="hljs-keyword">in</span> url_list ]<br><br>        <span class="hljs-keyword">await</span> asyncio.wait(tasks)<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>    start = time.time()<br>    asyncio.run( main() )<br>    end = time.time()<br><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;use time seconds:&quot;</span>,end-start)<br></code></pre></td></tr></table></figure>

<p>​        <strong>use time seconds: 1.2963719367980957</strong></p>
<p>综上可见，协程的速度得到明显提升。</p>
<p>注：第一种串行程序是一种<strong>同步方式</strong>，每一张照片按照相同的步骤<strong>排队顺序</strong>执行爬取；第二种协程程序是一种<strong>异步方式</strong>，每一张照片的爬取不等待完成，立马去爬取下一张。</p>
<h2 id="2-基于协程的异步编程"><a href="#2-基于协程的异步编程" class="headerlink" title="2. 基于协程的异步编程"></a>2. 基于协程的异步编程</h2><h3 id="2-1-事件循环"><a href="#2-1-事件循环" class="headerlink" title="2.1 事件循环"></a>2.1 事件循环</h3><p>事件循环可以理解为一个“死循环”，不断地循环检测某些代码的状态并执行。</p>
<figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs clean">#事件循环的伪代码<br><br>任务列表 = [ 任务<span class="hljs-number">1</span>， 任务<span class="hljs-number">2</span>， 任务<span class="hljs-number">3</span>，...]<br>###<br>在代码执行过程中，每个任务都会有状态，如：可以执行、已经完成、正在执行、IO等待（IO等待的任务也可以理解为不可执行的任务）等一些任务状态<br>###<br><br>while <span class="hljs-literal">True</span>:<br>	可执行任务列表，已完成任务列表 = 检测任务列表中所有任务的状态，并将<span class="hljs-string">&quot;可执行&quot;</span>状态和<span class="hljs-string">&quot;已完成&quot;</span>状态的任务返回<br>	 <br>	 for 就绪任务 <span class="hljs-keyword">in</span> 可执行任务列表:<br>	 		 执行已就绪的任务<br>	 		 <br>	 for 已完成的任务 <span class="hljs-keyword">in</span> 已完成的任务列表:<br>	 		在任务列表中移除 已完成的任务<br>	 		<br>	 如果 任务列表 中的任务均已完成，则终止时间循环<br></code></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> asyncio<br><br><span class="hljs-comment">#声明一个时间循环</span><br>loop = asyncio.get_event_loop()<br><br><span class="hljs-comment">#将任务放到&quot;任务列表中&quot;，循环检测其状态</span><br>loop.run_until_complete(任务)<br></code></pre></td></tr></table></figure>

<h3 id="2-2-快速上手"><a href="#2-2-快速上手" class="headerlink" title="2.2 快速上手"></a>2.2 快速上手</h3><p>协程函数，即在函数前加上关键字<code>async</code>，如<code>async def my_func()</code>。</p>
<p>协程对象，用协程函数名加上括号()的形式可以声明协程对象，如：<code>my_func()</code>即是一个协程对象。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#定义了一个协程函数</span><br><span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">my_func</span>():</span><br>  <span class="hljs-keyword">pass</span><br><br><span class="hljs-comment">#定义一个协程对象</span><br>result = my_func()<br><br><span class="hljs-comment">#注意：当协程函数加括号时，它的内部代码是不会执行的。即my_func()函数内的代码并没有执行，只是声明定义了一个协程对象。</span><br></code></pre></td></tr></table></figure>

<p> 如果想要运行协程函数的内部代码，需要把协程对象作为一个任务放入事件循环中去处理执行。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> asyncio<br><br><span class="hljs-comment">#定义一个协程函数</span><br><span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">my_func</span>():</span><br>  <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;快来搞我吧！&quot;</span>)<br><br><span class="hljs-comment">#声明一个协程对象</span><br>result = my_func()<br><br><br><span class="hljs-comment">#获取一个事件循环</span><br>loop = asyncio.get_event_loop()<br><span class="hljs-comment">#将协程对象作为任务交给事件循环处理执行</span><br>loop.run_until_complete( result )<br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">为了简化执行协程函数的代码，python3.7及以后的版本将</span><br><span class="hljs-string">#获取一个时间循环</span><br><span class="hljs-string">loop = asyncio.get_event_loop()</span><br><span class="hljs-string">#将协程对象作为任务交给事件循环处理执行</span><br><span class="hljs-string">loop.run_until_complete( result )</span><br><span class="hljs-string">上述两句代码语句简化为</span><br><span class="hljs-string">asyncio.run( reslut )</span><br><span class="hljs-string">表面上是省略了 获取事件循环 和 将协程对象作为任务交给事件循环 的过程</span><br><span class="hljs-string">直接运行协程对象，执行协程函数内部的代码</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><br><span class="hljs-comment">#执行协程对象</span><br><span class="hljs-comment">#asyncio.run( result )</span><br></code></pre></td></tr></table></figure>

<h3 id="2-3-await关键字"><a href="#2-3-await关键字" class="headerlink" title="2.3 await关键字"></a>2.3 await关键字</h3><p>await字面意思为等待，用来修饰<strong>可等待的对象</strong>，达到“中断”协程函数执行的效果，切换到其他任务执行，直到<strong>可等待的对象返回结果</strong>后，再继续执行后续代码。若无其他任务时，将一直等待<strong>可等待的对象</strong>返回结果后，再继续执行后续代码。</p>
<p>await + 可等待的对象（协程对象、Future对象、Task对象，目前，可以将它们简单为IO等待）</p>
<p>示例1:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> asyncio<br><br><span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">func</span>():</span><br>  <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;来玩呀！&quot;</span>)<br>  response = <span class="hljs-keyword">await</span> asyncio.sleep(<span class="hljs-number">2</span>)<br>  <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;好的&quot;</span>,response)<br>  <br>asyncio.run( func() )<br><br><span class="hljs-comment">#来玩呀！</span><br><span class="hljs-comment">#好的 None</span><br></code></pre></td></tr></table></figure>

<p>示例2:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> asyncio<br><br><span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">others</span>():</span><br>  <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;start&quot;</span>)<br>  <span class="hljs-keyword">await</span> asyncio.sleep(<span class="hljs-number">2</span>)<br>  <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;end&quot;</span>)<br>  <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;返回值&quot;</span><br><br><span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">func</span>():</span><br>  <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;执行协程函数内部代码&quot;</span>)<br>  <br>  <span class="hljs-comment">#遇到IO操作挂起当前协程（任务），等到IO操作完成后，再继续往下执行。当前程序挂起时，事件循环可以去执行其他协程（任务）</span><br>  response = <span class="hljs-keyword">await</span> others()		<span class="hljs-comment">#协程函数名加括号是协程对象</span><br>  <br>  <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;IO请求结束，结果为：&quot;</span>,response)<br>  <br>asyncio.run( func() )<br>  <br><span class="hljs-comment">#执行协程函数内部代码</span><br><span class="hljs-comment">#start</span><br><span class="hljs-comment">#end</span><br><span class="hljs-comment">#IO请求结束，结果为： 返回值</span><br></code></pre></td></tr></table></figure>

<p>示例3:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> asyncio<br><br><span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">others</span>():</span><br>  <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;start&quot;</span>)<br>  <span class="hljs-keyword">await</span> asyncio.sleep(<span class="hljs-number">2</span>)<br>  <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;end&quot;</span>)<br>  <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;返回值&quot;</span><br><br><span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">func</span>():</span><br>  <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;执行协程函数内部代码&quot;</span>)<br>  <br>  <span class="hljs-comment">#遇到IO操作挂起当前协程（任务），等到IO操作完成后，再继续往下执行。当前程序挂起时，事件循环可以去执行其他协程（任务）</span><br>  response1 = <span class="hljs-keyword">await</span> others()<br>  <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;IO请求结束，结果&quot;</span>,response1)<br>  <br>  response2 = <span class="hljs-keyword">await</span> others()<br>  <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;IO请求结束，结果&quot;</span>,response2)<br>  <br>asyncio.run( func() )<br><br><span class="hljs-comment">#执行协程函数内部代码</span><br><span class="hljs-comment">#start</span><br><span class="hljs-comment">#end</span><br><span class="hljs-comment">#IO请求结束，结果 返回值</span><br><span class="hljs-comment">#start</span><br><span class="hljs-comment">#end</span><br><span class="hljs-comment">#IO请求结束，结果 返回值</span><br></code></pre></td></tr></table></figure>

<h3 id="2-4-Task对象"><a href="#2-4-Task对象" class="headerlink" title="2.4 Task对象"></a>2.4 Task对象</h3><p>Task对象用于在事件循环中添加多个任务。</p>
<p>Tasks用于并发调度协程。通过<code>asyncio.create_task(协程对象)</code>的方式创建Task对象，这样可以让协程加入事件循环中等待被调度执行。除了使用<code>asyncio.create_task()</code>函数以外，还可以用低层次的<code>loop.create_task()</code>或<code>asyncio.ensure_future()</code>函数。不建议手动实例化Task对象。</p>
<p>注意：<code>asyncio.create_task()</code>函数在Python3.7中被加入，在Python3.7之前，可以改用低层次的<code>asyncio.create_future()</code>函数。</p>
<p>示例1:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> asyncio<br><br><span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">func</span>():</span><br>  <span class="hljs-built_in">print</span>(<span class="hljs-number">1</span>)<br>  <span class="hljs-keyword">await</span> asyncio.sleep(<span class="hljs-number">2</span>)<br>  <span class="hljs-built_in">print</span>(<span class="hljs-number">2</span>)<br>  <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;返回值&quot;</span><br><br><span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span>():</span><br>  <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;main()开始&quot;</span>)<br>  <br>  <span class="hljs-comment">#创建Task对象，并立即将当前执行的func函数任务添加到事件循环的任务列表之中。</span><br>  task1 = asyncio.create_task( func() )<br>  <br>  <span class="hljs-comment">#创建Task对象，并立即将当前执行的func函数任务添加到事件循环的任务列表之中。</span><br>  task2 = asyncio.create_task( func() )<br>  <br>  <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;main()结束&quot;</span>)<br>  <br>  <span class="hljs-comment">#当执行某协程遇到IO操作时，会自动化切换到其他任务。</span><br>  <span class="hljs-comment">#此处的await是等待相对应的协程全都执行完毕并获取结果</span><br>  ret1 = <span class="hljs-keyword">await</span> task1<br>  ret2 = <span class="hljs-keyword">await</span> task2<br>  <span class="hljs-built_in">print</span>(ret1,ret2)<br>  <br>asyncio.run( main() )<br><br><span class="hljs-comment">#main()开始</span><br><span class="hljs-comment">#main()结束</span><br><span class="hljs-comment">#1</span><br><span class="hljs-comment">#1</span><br><span class="hljs-comment">#2</span><br><span class="hljs-comment">#2</span><br><span class="hljs-comment">#返回值 返回值</span><br></code></pre></td></tr></table></figure>

<p>示例2:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> asyncio<br><br><br><span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">func</span>():</span><br>    <span class="hljs-built_in">print</span>(<span class="hljs-number">1</span>)<br>    <span class="hljs-keyword">await</span> asyncio.sleep(<span class="hljs-number">2</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-number">2</span>)<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;返回值&quot;</span><br><br><br><span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span>():</span><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;main()开始&quot;</span>)<br><br>    task_list = [<br>        asyncio.create_task(func(),name=<span class="hljs-string">&quot;n1&quot;</span>),<br>        asyncio.create_task(func(),name=<span class="hljs-string">&quot;n2&quot;</span>)<br>    ]<br><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;main()结束&quot;</span>)<br><br>    <span class="hljs-comment">#将task_list中的所有任务全部都等待，返回done的集合数据类型，集合元素是对象类型</span><br>    <span class="hljs-comment">#pending：返回超出timeout时间后还未完成的集合结果（当timeout默认值为None时，pending无意义，返回空集合）</span><br>    done,pending = <span class="hljs-keyword">await</span> asyncio.wait(task_list,timeout=<span class="hljs-literal">None</span>)<br>    <span class="hljs-built_in">print</span>(done)<br><br>asyncio.run(main())<br><br><span class="hljs-comment">#main()开始</span><br><span class="hljs-comment">#main()结束</span><br><span class="hljs-comment">#1</span><br><span class="hljs-comment">#1</span><br><span class="hljs-comment">#2</span><br><span class="hljs-comment">#2</span><br><span class="hljs-comment">#&#123;&lt;Task finished name=&#x27;n2&#x27; coro=&lt;func() done, defined at /Users/lee/Desktop/MyStudy/PyProjects/协程异步编程/task示例2.py:4&gt; result=&#x27;返回值&#x27;&gt;, &lt;Task finished name=&#x27;n1&#x27; coro=&lt;func() done, defined at /Users/lee/Desktop/MyStudy/PyProjects/协程异步编程/task示例2.py:4&gt; result=&#x27;返回值&#x27;&gt;&#125;</span><br></code></pre></td></tr></table></figure>

<p>示例3:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> asyncio<br><br><span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">func</span>():</span><br>  <span class="hljs-built_in">print</span>(<span class="hljs-number">1</span>)<br>  <span class="hljs-keyword">await</span> asyncio.sleep(<span class="hljs-number">2</span>)<br>  <span class="hljs-built_in">print</span>(<span class="hljs-number">2</span>)<br>  <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;返回值&quot;</span><br><br>task_list = [<br>    <span class="hljs-comment">#在示例1中，我们强调这句代码的含义：</span><br>  	<span class="hljs-comment">#创建Task对象，并立即将当前执行的func函数任务添加到事件循环的任务列表之中。</span><br>  	<span class="hljs-comment">#前提是已经创建了事件循环</span><br>    <span class="hljs-comment">#但是执行该句代码时，当前未曾创建事件循环</span><br>    asyncio.create_task(func(),name=<span class="hljs-string">&quot;n1&quot;</span>),<br>    asyncio.create_task(func(),name=<span class="hljs-string">&quot;n2&quot;</span>)<br>]<br><br><span class="hljs-comment">#asyncio.wait(task_list)为任务列表中的每个任务添加await关键字</span><br>done,pending = asyncio.run( asyncio.wait(task_list) )<br><span class="hljs-built_in">print</span>(done)<br><br><span class="hljs-comment">#Error:</span><br><span class="hljs-comment">#RuntimeError: no running event loop</span><br><span class="hljs-comment">#sys:1: RuntimeWarning: coroutine &#x27;func&#x27; was never awaited</span><br></code></pre></td></tr></table></figure>

<p>示例4:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#将示例3改正如下：</span><br><span class="hljs-keyword">import</span> asyncio<br><br><span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">func</span>():</span><br>  <span class="hljs-built_in">print</span>(<span class="hljs-number">1</span>)<br>  <span class="hljs-keyword">await</span> asyncio.sleep(<span class="hljs-number">2</span>)<br>  <span class="hljs-built_in">print</span>(<span class="hljs-number">2</span>)<br>  <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;返回值&quot;</span><br><br>task_list = [<br>    func(),<br>    func()<br>]<br><br><span class="hljs-comment">#asyncio.wait(task_list)为任务列表中的每个任务添加awaith关键字</span><br>done,pending = asyncio.run( asyncio.wait(task_list) )<br><span class="hljs-built_in">print</span>(done)<br><br><br><br><span class="hljs-comment">#1</span><br><span class="hljs-comment">#1</span><br><span class="hljs-comment">#2</span><br><span class="hljs-comment">#2</span><br><span class="hljs-comment">#&#123;&lt;Task finished name=&#x27;Task-2&#x27; coro=&lt;func() done, defined at /Users/lee/Desktop/MyStudy/PyProjects/协程异步编程/task示例4.py:3&gt; result=&#x27;返回值&#x27;&gt;, &lt;Task finished name=&#x27;Task-3&#x27; coro=&lt;func() done, defined at /Users/lee/Desktop/MyStudy/PyProjects/协程异步编程/task示例4.py:3&gt; result=&#x27;返回值&#x27;&gt;&#125;</span><br></code></pre></td></tr></table></figure>

<p>Task对象可以立即将某个任务放入事件循环的任务列表中。</p>
<h3 id="2-5-asyncio-Future对象"><a href="#2-5-asyncio-Future对象" class="headerlink" title="2.5 asyncio.Future对象"></a>2.5 asyncio.Future对象</h3><p>Future更偏向基础底层，它是Task的基类（Task类型继承了Future类），一般情况下不常用。</p>
<p>Task继承了Future，Task对象内部的await结果的处理基于Future对象内部封装的<code>_state</code>字段。<code>_state</code>字段用来记录任务的状态是否完成，来确定Task对象内部的await是否等到了返回结果。</p>
<p>示例1:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> asyncio<br><br><span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span>():</span><br>  <br>  <span class="hljs-comment">#获取当前正在进行的事件循环</span><br>  loop = asyncio.get_running_loop()<br>  <br>  <span class="hljs-comment">#创建一个任务（Future对象），但是这个任务什么也不干</span><br>  fut = loop.create_future()<br>  <br>  <span class="hljs-comment">#等待任务最终结果（Future对象），因为fut什么也没干，没有结果则会一直等下去。</span><br>  <span class="hljs-keyword">await</span> fut<br>  <br>asyncio.run( main() )<br></code></pre></td></tr></table></figure>

<p>示例2:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> asyncio<br><br><span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">set_after</span>(<span class="hljs-params">fut</span>):</span><br>  <span class="hljs-keyword">await</span> asyncio.sleep(<span class="hljs-number">2</span>)<br>  fut.set_result(<span class="hljs-string">&quot;666&quot;</span>)<br><br><span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span>():</span><br>  <br>  <span class="hljs-comment">#获取当前正在进行的事件循环</span><br>  loop = asyncio.get_running_loop()<br>  <br>  <span class="hljs-comment">##创建一个任务（Future对象），没有任务绑定行为，则这个任务永远不知道什么时候结束</span><br>  fut = loop.create_future()<br>  <br>  <span class="hljs-comment">#创建一个任务（Task对象），绑定了set_after函数，函数内部在2s之后，会给fut赋值。</span><br>  <span class="hljs-comment">#即手动设置future任务的最终结果，那么future就可以结束了。</span><br>  <span class="hljs-keyword">await</span> loop.create_task( set_after(fut) )<br>  <br>  <span class="hljs-comment">#等待任务最终结果（Future对象），因为fut什么也没干，没有结果则会一直等下去。</span><br>  data = <span class="hljs-keyword">await</span> fut<br>  <span class="hljs-built_in">print</span>(data)<br>  <br>asyncio.run( main() )<br><br><span class="hljs-comment">#666</span><br></code></pre></td></tr></table></figure>

<h3 id="2-6-concurrent-futures-Futures对象"><a href="#2-6-concurrent-futures-Futures对象" class="headerlink" title="2.6 concurrent.futures.Futures对象"></a>2.6 concurrent.futures.Futures对象</h3><p> <code>concurrent.futures.Future</code>与<code>asyncio.Future</code>没有任何关系。它是使用线程池、进程池实现异步操作时需要用到的对象。</p>
<p>示例1:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> time<br><span class="hljs-keyword">from</span> concurrent.futures <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> concurrent.futures <span class="hljs-keyword">import</span> ThreadPoolExecutor<br><span class="hljs-keyword">from</span> concurrent.futures <span class="hljs-keyword">import</span> ProcessPoolExecutor<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">func</span>(<span class="hljs-params">value</span>):</span><br>  time.sleep(<span class="hljs-number">1</span>)<br>  <span class="hljs-built_in">print</span>(value)<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">123</span><br><br><span class="hljs-comment">#创建线程池</span><br>pool = ThreadPoolExecutor(max_workers=<span class="hljs-number">5</span>)<br><br><span class="hljs-comment">#创建进程池</span><br><span class="hljs-comment">#pool = ProcessPoolExecutor(max_wordkers=5)</span><br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">10</span>):<br>  fut = pool.submit(func,i)<br>  <span class="hljs-built_in">print</span>(fut.result())<br></code></pre></td></tr></table></figure>

<p>注：在以后的项目中，<code>concurrent.futures.Future</code>与<code>asyncio.Future</code>通常会交叉使用。crm项目的80%IO都是基于协程异步+MySQL（若不支持asyncio的协程，则需要用基于线程或者进程的异步编程）</p>
<p>示例2:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> time<br><span class="hljs-keyword">import</span> asyncio<br><span class="hljs-keyword">import</span> concurrent.futures<br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">func1</span>():</span><br>    <span class="hljs-comment"># 某个耗时操作</span><br>    time.sleep(<span class="hljs-number">1</span>)<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;SB&quot;</span><br><br><br><span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span>():</span><br>    loop = asyncio.get_event_loop()<br><br>    <span class="hljs-comment">###使用线程池将非协程异步函数改造成可等待的对象###</span><br>    <span class="hljs-comment"># 1.Run in the default loop&#x27;s executor(默认ThtreadPoolExecutor)</span><br>    <span class="hljs-comment"># 第一步：内部会先调用ThreadPoolExecutor的submit方法去线程池中申请一个线程去执行func1函数，并返回一个concurrent.Future对象</span><br>    <span class="hljs-comment"># 第二步：调用asyncio.wrap_future将concurrent.futures.Future对象包装为asyncio.Future对象。</span><br>    <span class="hljs-comment"># 因为concurrent.futures.Future对象不支持await语法，所以需要包装为asyncio.future对象才能使用。</span><br><br>    fut = loop.run_in_executor(<span class="hljs-literal">None</span>, func1)<br>    <span class="hljs-comment">#loop.run_in_executor(executor, func, *args)</span><br>		<span class="hljs-comment">#executor 可以是 ThreadPoolExecutor或者ProcessPoolExecutor，如果是None，则使用默认线程池</span><br>    <span class="hljs-comment">#func是执行的函数，*args是func()的参数</span><br>    <span class="hljs-comment">#返回可等待的对象</span><br>    result = <span class="hljs-keyword">await</span> fut<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;default thread pool&quot;</span>, result)<br><br><br><span class="hljs-comment"># # 2. Run in a custom thread pool:</span><br><span class="hljs-comment"># with concurrent.futures.ThreadPoolExecutor() as pool:</span><br><span class="hljs-comment">#     reault = await loop.run_in_executor(pool, func1)</span><br><span class="hljs-comment">#     print(&quot;custom thread pool&quot;, result)</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># # 3. Run in a custom process pool:</span><br><span class="hljs-comment"># with concurrent.futures.ProcessPoolexecutor() as pool:</span><br><span class="hljs-comment">#     result = await loop.run_in_executor(pool, func1)</span><br><span class="hljs-comment">#     print(&quot;custom process pool&quot;, result)</span><br><br>asyncio.run(main())<br><span class="hljs-comment">#default thread pool SB</span><br></code></pre></td></tr></table></figure>

<p>​        案例：asyncio + 不支持异步的模块</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> asyncio<br><span class="hljs-keyword">import</span> requests<br><br><span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_image</span>(<span class="hljs-params">url</span>):</span><br>  <br>  <span class="hljs-comment">#发送网络请求，下载图片（遇到网络下载图片的IO请求，自动化切换到一他任务）</span><br>  <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;图片地址：&quot;</span>,url)<br>  <br>  loop = asyncio.get_event_loop()<br>  <span class="hljs-comment">#requests模块默认不支持异步操作（这里没有使用aiohttp模块），所以就使用线程池配合实现了。</span><br>  future = loop.run_in_executor(<span class="hljs-literal">None</span>,requests.get,url)<br>  <br>  response = <span class="hljs-keyword">await</span> future<br>  <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;下载完成！&quot;</span>)<br>  <br>  <span class="hljs-comment">#图片保存在本地</span><br>  filename = url.split(<span class="hljs-string">&quot;/&quot;</span>)[-<span class="hljs-number">2</span>] + <span class="hljs-string">&quot;.jpg&quot;</span><br>  <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(filename,<span class="hljs-string">&quot;wb&quot;</span>) <span class="hljs-keyword">as</span> fp:<br>    fp.write(response.content)<br>  <br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>  url_list = [     <span class="hljs-string">&quot;https://uploadfile.bizhizu.cn/up/80/47/dd/8047dd9023aebb82a50a42dd11cf2897.png.230.350.jpg&quot;</span>,  <br>              <span class="hljs-string">&quot;https://uploadfile.bizhizu.cn/up/e7/fd/05/e7fd0597635c1767431ddfd1d6d645e6.jpg.230.350.jpg&quot;</span>,<br>        <span class="hljs-string">&quot;https://uploadfile.bizhizu.cn/up/06/77/3f/06773fbb963b0ba66206ac82eb302d28.jpg.230.350.jpg&quot;</span><br>  ]<br>  <span class="hljs-comment">#get_image是协程函数，加括号后：get_image()是协程对象</span><br>  tasks = [ get_image(url) <span class="hljs-keyword">for</span> url <span class="hljs-keyword">in</span> url_list ]<br>      <br>  <span class="hljs-comment"># loop = asyncio.get_event_loop()</span><br>  <span class="hljs-comment"># loop.run_until_complete(asyncio.wait(tasks))</span><br>  <span class="hljs-comment">#asyncio.await为任务列表中的每一个任务添加await关键字</span><br>  asyncio.run(asyncio.wait(tasks))<br>  <br><span class="hljs-comment">#图片地址： https://uploadfile.bizhizu.cn/up/06/77/3f/06773fbb963b0ba66206ac82eb302d28.jpg.230.350.jpg</span><br><span class="hljs-comment">#图片地址： https://uploadfile.bizhizu.cn/up/80/47/dd/8047dd9023aebb82a50a42dd11cf2897.png.230.350.jpg</span><br><span class="hljs-comment">#图片地址： https://uploadfile.bizhizu.cn/up/e7/fd/05/e7fd0597635c1767431ddfd1d6d645e6.jpg.230.350.jpg</span><br><span class="hljs-comment">#下载完成！</span><br><span class="hljs-comment">#下载完成！</span><br><span class="hljs-comment">#下载完成！</span><br></code></pre></td></tr></table></figure>

<h3 id="2-7-异步迭代器"><a href="#2-7-异步迭代器" class="headerlink" title="2.7 异步迭代器"></a>2.7 异步迭代器</h3><p><strong>异步迭代器：</strong>实现了<code>__aiter__()</code>和<code>__anext__()</code>方法的对象。<code>__anext__</code>必须返回一个awaitable对象。<code>async_for</code>会处理异步迭代器的<code>__anext__()</code>方法所返回的可等待对象，直到其引发一个<code>StopAsyncIteration</code>异常。由<code>PEP 492</code>引入。</p>
<p><strong>异步可迭代对象：</strong>可以在<code>async_for</code>语句中被使用的对象。必须通过它的<code>__aiter__()</code>方法返回一个<code>asynchronous iterator</code>。由<code>PEP 492</code>引入。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> asyncio<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Reader</span>(<span class="hljs-params"><span class="hljs-built_in">object</span></span>):</span><br>  <span class="hljs-comment"># 自定义异步迭代器（同时也是异步可迭代对象）</span><br>  <br>  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self</span>):</span><br>    self.count = <span class="hljs-number">0</span><br>  <br>  <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">readline</span>(<span class="hljs-params">self</span>):</span><br>    <span class="hljs-comment">#await asyncio.sleep(1)</span><br>    self.count += <span class="hljs-number">1</span><br>    <span class="hljs-keyword">if</span> self.count == <span class="hljs-number">100</span>:<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span><br>    <span class="hljs-keyword">return</span> self.count<br>  <br>  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__aiter__</span>(<span class="hljs-params">self</span>):</span><br>    <span class="hljs-keyword">return</span> self<br>  <br>  <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__anext__</span>(<span class="hljs-params">self</span>):</span><br>    val = <span class="hljs-keyword">await</span> self.readline()<br>    <span class="hljs-keyword">if</span> val == <span class="hljs-literal">None</span>:<br>      <span class="hljs-keyword">raise</span> StopAsyncIteration<br>    <span class="hljs-keyword">return</span> val<br>  <br><span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">func</span>():</span><br>  obj = Reader()<br>  <span class="hljs-comment">#循环语句必须用async for，且必须放在协程函数内</span><br>	<span class="hljs-keyword">async</span> <span class="hljs-keyword">for</span> item <span class="hljs-keyword">in</span> obj:<br>    <span class="hljs-built_in">print</span>(item)<br>    <br>asyncio.run(func())<br></code></pre></td></tr></table></figure>

<h3 id="2-8-异步上下文管理器"><a href="#2-8-异步上下文管理器" class="headerlink" title="2.8 异步上下文管理器"></a>2.8 异步上下文管理器</h3><p><strong>异步上下文管理器：</strong>这种对象通过定义<code>__aenter__()</code>和<code>__aexit__()</code>方法对<code>async with</code>语句中的环境进行控制。由<code>PEP 492</code>引入。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> asyncio<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AsyncContextManager</span>:</span><br>  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self</span>):</span><br>    self.conn = conn<br>    <br>  <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">do_something</span>(<span class="hljs-params">self</span>):</span><br>    <span class="hljs-comment">#异步操作数据库</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">666</span><br>  <br>  <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__aenter__</span>(<span class="hljs-params">self</span>):</span><br>    <span class="hljs-comment">#异步连接数据库</span><br>    self.conn = <span class="hljs-keyword">await</span> asyncio.sleep(<span class="hljs-number">1</span>)<br>    <span class="hljs-keyword">return</span> self<br>  <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__aexit__</span>(<span class="hljs-params">self,exc_type,exc,tb</span>):</span><br>    <span class="hljs-comment">#异步关闭数据库</span><br>    <span class="hljs-keyword">await</span> asyncio.sleep(<span class="hljs-number">1</span>)<br>    <br><span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">func</span>():</span>    <br>  <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> AsyncContextManager() <span class="hljs-keyword">as</span> f:<br>    result = <span class="hljs-keyword">await</span> f.do_something()<br>    <span class="hljs-built_in">print</span>(result)<br>    <br>asyncio.run( func() )<br></code></pre></td></tr></table></figure>

<h2 id="3-uvloop"><a href="#3-uvloop" class="headerlink" title="3. uvloop"></a>3. uvloop</h2><p>uvloop是asyncio事件循环的替代方案，它的事件循环效率高于默认asyncio的事件循环，是一种在asyncio基础上再次提升速度的方法。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs pyhton">pip3 install uvloop<br></code></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> asyncio<br><span class="hljs-keyword">import</span> uvloop<br><span class="hljs-comment">#asyncio事件循环替换为uvloop</span><br>asyncio.set_event_loop_policy(uvloop.EventLoopPolicy())<br><br><span class="hljs-comment">#编写asyncio的代码，与之前的一致即可</span><br><br><br><span class="hljs-comment">#内部的事件循环自动化变为uvloop</span><br><br>asyncio.run(...)<br></code></pre></td></tr></table></figure>

<p><strong>注意：Django和Fastapi框架快是因为使用了一个asgi：uvicorn</strong></p>
<h2 id="4-实战案例"><a href="#4-实战案例" class="headerlink" title="4. 实战案例"></a>4. 实战案例</h2><h3 id="4-1-异步redis"><a href="#4-1-异步redis" class="headerlink" title="4.1 异步redis"></a>4.1 异步redis</h3><p>在使用Python代码操作redis时，连接、操作、断开都属于网络IO。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">pip3 install aioredis				<span class="hljs-comment">#支持异步操作redis的库</span><br></code></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> asyncio<br><span class="hljs-keyword">import</span> aioredis<br><br><span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">execute</span>(<span class="hljs-params">address,password</span>):</span><br>  <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;开始执行&quot;</span>,address)<br>  <span class="hljs-comment">#网络IO操作：创建redis连接</span><br>  redis = <span class="hljs-keyword">await</span> aioredis.create_redis(address,password=password)<br>  <br>  <span class="hljs-comment">#网络IO操作：在redis中设置哈希值car，内部在设置三个键值对，即：redis = &#123; car:&#123; key1:1,key2:2,key3:3&#125; &#125;</span><br>	<span class="hljs-keyword">await</span> redis.hmset_dict(<span class="hljs-string">&quot;car&quot;</span>,key1=<span class="hljs-number">1</span>,key2=<span class="hljs-number">2</span>,key3=<span class="hljs-number">3</span>)<br>  <br>  <span class="hljs-comment">#网络IO操作：去redis中获取值</span><br>  result = <span class="hljs-keyword">await</span> redis.hgetall(<span class="hljs-string">&quot;car&quot;</span>,encoding=<span class="hljs-string">&quot;utf-8&quot;</span>)<br>  <span class="hljs-built_in">print</span>(result)<br>  <br>  redis.close()<br>  <span class="hljs-comment">#网络IO操作：关闭redis连接</span><br>  <span class="hljs-keyword">await</span> redis.wait_closed()<br>  <br>  <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;结束&quot;</span>,address)<br>  <br>asyncio.run( excute(<span class="hljs-string">&quot;redis://47.93.4.198:6379&quot;</span>,<span class="hljs-string">&quot;root12345&quot;</span>) )<br><br></code></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> asyncio<br><span class="hljs-keyword">import</span> aioredis<br><br><span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">execute</span>(<span class="hljs-params">address,password</span>):</span><br>  <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;开始执行&quot;</span>,address)<br>  <span class="hljs-comment">#网络IO操作：创建redis连接</span><br>  redis = <span class="hljs-keyword">await</span> aioredis.create_redis(address,password=password)<br>  <br>  <span class="hljs-comment">#网络IO操作：在redis中设置哈希值car，内部在设置三个键值对，即：redis = &#123; car:&#123; key1:1,key2:2,key3:3&#125; &#125;</span><br>	<span class="hljs-keyword">await</span> redis.hmset_dict(<span class="hljs-string">&quot;car&quot;</span>,key1=<span class="hljs-number">1</span>,key2=<span class="hljs-number">2</span>,key3=<span class="hljs-number">3</span>)<br>  <br>  <span class="hljs-comment">#网络IO操作：去redis中获取值</span><br>  result = <span class="hljs-keyword">await</span> redis.hgetall(<span class="hljs-string">&quot;car&quot;</span>,encoding=<span class="hljs-string">&quot;utf-8&quot;</span>)<br>  <span class="hljs-built_in">print</span>(result)<br>  <br>  redis.close()<br>  <span class="hljs-comment">#网络IO操作：关闭redis连接</span><br>  <span class="hljs-keyword">await</span> redis.wait_closed()<br>  <br>  <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;结束&quot;</span>,address)<br><br>task_list = [<br>  excute(<span class="hljs-string">&quot;redis://47.93.4.198:6379&quot;</span>,<span class="hljs-string">&quot;root12345&quot;</span>),<br>  excute(<span class="hljs-string">&quot;redis://47.93.4.198:6379&quot;</span>,<span class="hljs-string">&quot;root12345&quot;</span>) <br>]<br><br>asyncio.run(asyncio.wait(task_list))<br></code></pre></td></tr></table></figure>

<h3 id="4-2-异步MySQL"><a href="#4-2-异步MySQL" class="headerlink" title="4.2 异步MySQL"></a>4.2 异步MySQL</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">pip3 install aiomysql<br></code></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> asyncio<br><span class="hljs-keyword">import</span> aiomysql<br><br><span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">execute</span>():</span><br>  <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;开始&quot;</span>,host)<br>  <span class="hljs-comment">#网络IO操作：连接MySQL</span><br>  conn = <span class="hljs-keyword">await</span> aiomysql.connect(host=<span class="hljs-string">&quot;127.0.0.1&quot;</span>,port=<span class="hljs-number">3306</span>,user=<span class="hljs-string">&quot;root&quot;</span>,password=<span class="hljs-string">&quot;root123&quot;</span>)<br>  <br>  <span class="hljs-comment">#网络IO操作：创建光标cursor</span><br>  cursor = <span class="hljs-keyword">await</span> conn.cursor()<br>  <br>  <span class="hljs-comment">#网络IO操作：执行SQL</span><br>  <span class="hljs-keyword">await</span> cursor.execute(<span class="hljs-string">&quot;SELECT HOST,USER FROM user&quot;</span>)<br>  <br>  <span class="hljs-comment">#网络IO操作：获取SQL结果</span><br>  result = <span class="hljs-keyword">await</span> cursor.fetchall()<br>  <span class="hljs-built_in">print</span>(result)<br>  <br>  <span class="hljs-comment">#网络IO操作：关闭连接</span><br>  <span class="hljs-keyword">await</span> cursor.close()<br>  conn.close()<br>  <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;结束&quot;</span>,host)<br>  <br>asyncio.run(execute())<br></code></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> asyncio<br><span class="hljs-keyword">import</span> aiomysql<br><br><span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">execute</span>():</span><br>  <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;开始&quot;</span>,host)<br>  <span class="hljs-comment">#网络IO操作：连接MySQL</span><br>  conn = <span class="hljs-keyword">await</span> aiomysql.connect(host=<span class="hljs-string">&quot;127.0.0.1&quot;</span>,port=<span class="hljs-number">3306</span>,user=<span class="hljs-string">&quot;root&quot;</span>,password=<span class="hljs-string">&quot;root123&quot;</span>)<br>  <br>  <span class="hljs-comment">#网络IO操作：创建光标cursor</span><br>  cursor = <span class="hljs-keyword">await</span> conn.cursor()<br>  <br>  <span class="hljs-comment">#网络IO操作：执行SQL</span><br>  <span class="hljs-keyword">await</span> cursor.execute(<span class="hljs-string">&quot;SELECT HOST,USER FROM user&quot;</span>)<br>  <br>  <span class="hljs-comment">#网络IO操作：获取SQL结果</span><br>  result = <span class="hljs-keyword">await</span> cursor.fetchall()<br>  <span class="hljs-built_in">print</span>(result)<br>  <br>  <span class="hljs-comment">#网络IO操作：关闭连接</span><br>  <span class="hljs-keyword">await</span> cursor.close()<br>  conn.close()<br>  <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;结束&quot;</span>,host)<br>  <br>task_list = [<br>  execute(<span class="hljs-string">&quot;47.93.41.197&quot;</span>,<span class="hljs-string">&quot;root123&quot;</span>),<br>  execute(<span class="hljs-string">&quot;47.93.41.197&quot;</span>,<span class="hljs-string">&quot;root123&quot;</span>)<br>]<br><br>asyncio.run(asyncio.wait(task_list))<br></code></pre></td></tr></table></figure>

<h3 id="4-3-FastAPI框架"><a href="#4-3-FastAPI框架" class="headerlink" title="4.3 FastAPI框架"></a>4.3 FastAPI框架</h3><p>以FastAPI框架为例，其他框架以此类推即可。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">pip3 install fastapi<br></code></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">pip3 install uvicorn					<span class="hljs-comment">#asgi内部基于uvloop</span><br></code></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> asyncio<br><br><span class="hljs-keyword">import</span> uvicorn<br><span class="hljs-keyword">from</span> fastapi <span class="hljs-keyword">import</span> FastAPI<br><br>app = FadtAPI()<br><br><span class="hljs-meta">@app.get(<span class="hljs-params"><span class="hljs-string">&quot;/&quot;</span></span>)</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">index</span>():</span><br>  <span class="hljs-comment">#普通操作接口</span><br>  <span class="hljs-comment">#遇到网络IO会等待</span><br>  <span class="hljs-keyword">return</span> &#123; <span class="hljs-string">&quot;message&quot;</span>:<span class="hljs-string">&quot;Hello World&quot;</span> &#125;<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>  uvicorn.run(<span class="hljs-string">&quot;luffy:app&quot;</span>,host=<span class="hljs-string">&quot;127.0.0.1&quot;</span>,port=<span class="hljs-number">5000</span>,log_level=<span class="hljs-string">&quot;info&quot;</span>)<br></code></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#文件名：luffy.py</span><br><span class="hljs-keyword">import</span> asyncio<br><br><span class="hljs-keyword">import</span> uvicorn<br><span class="hljs-keyword">import</span> aioredis<br><span class="hljs-keyword">from</span> fastapi <span class="hljs-keyword">import</span> FastAPI<br><span class="hljs-keyword">from</span> fastapi <span class="hljs-keyword">import</span> FastAPI<br><br>app = FadtAPI()<br><br><span class="hljs-comment">#创建一个redis连接池</span><br>REDIS_POOL = aioreids.ConnectionsPool(<span class="hljs-string">&quot;redis://47.193.14.198:6379&quot;</span>,password=<span class="hljs-string">&quot;root123&quot;</span>,minsize=<span class="hljs-number">1</span>,maxsize=<span class="hljs-number">10</span>)<br><br><span class="hljs-meta">@app.get(<span class="hljs-params"><span class="hljs-string">&quot;/&quot;</span></span>)</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">index</span>():</span><br>  <span class="hljs-comment">#普通操作接口</span><br>  <span class="hljs-comment">#遇到网络IO会等待</span><br>  <span class="hljs-keyword">return</span> &#123; <span class="hljs-string">&quot;message&quot;</span>:<span class="hljs-string">&quot;Hello World&quot;</span> &#125;<br><br><span class="hljs-meta">@app.get(<span class="hljs-params"><span class="hljs-string">&quot;/red&quot;</span></span>)</span><br><span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">red</span>():</span><br>  <span class="hljs-comment">#异步操作接口</span><br>  <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;请求来了&quot;</span>)<br>  <br>  <span class="hljs-keyword">await</span> asyncio.sleep(<span class="hljs-number">1</span>)<br>  <span class="hljs-comment">#连接池获取一个连接</span><br>  conn = <span class="hljs-keyword">await</span> REDIS_POOL.acquire()<br>  redis = Redis(conn)<br>  <br>  <span class="hljs-comment">#设置值</span><br>  <span class="hljs-keyword">await</span> redis.hmset_dict(<span class="hljs-string">&quot;car&quot;</span>,key1=<span class="hljs-number">1</span>,key2=<span class="hljs-number">2</span>,key3=<span class="hljs-number">3</span>)<br>  <br>  <span class="hljs-comment">#读取值</span><br>  result = <span class="hljs-keyword">await</span> redis.hgetall(<span class="hljs-string">&quot;car&quot;</span>,encoding=<span class="hljs-string">&quot;utf-8&quot;</span>)<br>  <span class="hljs-built_in">print</span>(result)<br>  <br>  <span class="hljs-comment">#连接归还连接池</span><br>  REDIS_POOL.release(conn)<br>  <br>  <span class="hljs-keyword">return</span> result<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>  <span class="hljs-comment">#文件名：luffy.py</span><br> uvicorn.run(<span class="hljs-string">&quot;luffy:app&quot;</span>,host=<span class="hljs-string">&quot;127.0.0.1&quot;</span>,port=<span class="hljs-number">5000</span>,log_level=<span class="hljs-string">&quot;info&quot;</span>)<br></code></pre></td></tr></table></figure>

<h3 id="4-4-异步爬虫"><a href="#4-4-异步爬虫" class="headerlink" title="4.4 异步爬虫"></a>4.4 异步爬虫</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">pip3 install aiohttp<br></code></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> aiohttp<br><span class="hljs-keyword">import</span> asyncio<br><br><span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">fetch</span>(<span class="hljs-params">session,url</span>):</span><br>  <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;发送请求：&quot;</span>,url)<br>  <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> session.get(url,verify_ssl=<span class="hljs-literal">False</span>) <span class="hljs-keyword">as</span> response:<br>    text = <span class="hljs-keyword">await</span> response.text()<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;得到结果：&quot;</span>,url,<span class="hljs-built_in">len</span>(text))<br>    <span class="hljs-keyword">return</span> text<br>    <br><span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span>():</span><br>  <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> aiohttp.ClientSession() <span class="hljs-keyword">as</span> session:<br>    url_list = [<br>      <span class="hljs-string">&quot;https://python.org&quot;</span>,<br>      <span class="hljs-string">&quot;https://www.baidu.com&quot;</span>,<br>      <span class="hljs-string">&quot;https://www.pythonav.com&quot;</span><br>    ]<br>    tasks = [ asyncio.create_task(fetch(session,url)) <span class="hljs-keyword">for</span> url <span class="hljs-keyword">in</span> url_list ]<br>    done,pending = <span class="hljs-keyword">await</span> asyncio.wait(tasks)<br>    <br><span class="hljs-keyword">if</span> __name__ ==<span class="hljs-string">&quot;__main__&quot;</span>:<br>  asyncio.run( main() )<br></code></pre></td></tr></table></figure>

<h2 id="5-总结"><a href="#5-总结" class="headerlink" title="5. 总结"></a>5. 总结</h2><p>最大的意义：通过<strong>一个线程</strong>充分其IO等待时间去做其他的事情。</p>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                
              </div>
              
                <p class="note note-warning">
                  
                    本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！
                  
                </p>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2021/09/23/Python%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/">
                        <span class="hidden-mobile"></span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
  </div>
  

  

  
</footer>


  <!-- SCRIPTS -->
  
  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>

<!-- Plugins -->


  <script  src="/js/local-search.js" ></script>



  
    <script  src="/js/img-lazyload.js" ></script>
  



  



  
    <script  src="https://cdn.jsdelivr.net/npm/tocbot@4/dist/tocbot.min.js" ></script>
  
  
    <script  src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.js" ></script>
  
  
    <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4/anchor.min.js" ></script>
  
  
    <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js" ></script>
  






  <script  src="https://cdn.jsdelivr.net/npm/typed.js@2/lib/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
      typing(title)
      
    })(window, document);
  </script>















<!-- 主题的启动项 保持在最底部 -->
<script  src="/js/boot.js" ></script>


</body>
</html>
